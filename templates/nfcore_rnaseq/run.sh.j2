#!/usr/bin/env bash
set -euo pipefail

# Defaults (can be adjusted here without exposing as BPM params)
NFCORE_VERSION="${NFCORE_VERSION:-3.20.0}"
PROFILE="${PROFILE:-docker}"   # docker|singularity|apptainer|conda
OUTDIR="${OUTDIR:-results}"

# Required param from BPM
GENOME="{{ ctx.params.genome }}"

# The samplesheet.csv is generated by the pre_run hook
# (hooks.nfcore_rnaseq_samplesheet_reverse:main) in this same folder.
SAMPLESHEET="samplesheet.csv"

# Optional passthrough via environment for advanced use
#   NF_EXTRA_ARGS="--max_cpus 16 --max_memory 64.GB -resume"
NF_EXTRA_ARGS=${NF_EXTRA_ARGS:-}

echo "[info] $(date) nf-core/rnaseq v${NFCORE_VERSION} profile=${PROFILE} genome=${GENOME}"
nextflow -version || true
mkdir -p "${OUTDIR}"

CMD=( nextflow run nf-core/rnaseq \
      -r "${NFCORE_VERSION}" \
      -profile "${PROFILE}" \
      -c nextflow.config \
      --input "${SAMPLESHEET}" \
      --outdir "${OUTDIR}" \
      --genome "${GENOME}" )

if [[ -n "${NF_EXTRA_ARGS}" ]]; then
  # shellcheck disable=SC2206
  EXTRA_ARR=(${NF_EXTRA_ARGS})
  CMD+=("${EXTRA_ARR[@]}")
fi

printf 'Running:'
printf ' %q' "${CMD[@]}"
echo
printf '%q ' "${CMD[@]}" > .bpm_cmd.log
exec "${CMD[@]}"
