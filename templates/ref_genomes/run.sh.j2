#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/genomes.sh"

OUTDIR="${OUTDIR:-$PWD}"
mkdir -p "$OUTDIR"

for entry in "${GENOMES[@]}"; do
  IFS='|' read -r GID FASTA GTF <<< "$entry"

  echo "=== $GID ==="
  ROOT="$OUTDIR/$GID"
  mkdir -p "$ROOT/src"

  python3 "$SCRIPT_DIR/runner.py" stage --gid "$GID" --fasta "$FASTA" --gtf "$GTF" --outdir "$ROOT" > "$ROOT/stage.txt"
  source <(sed 's/^/export /' "$ROOT/stage.txt")

  ERCC_FASTA=""
  python3 "$SCRIPT_DIR/runner.py" ercc --gid "$GID" --fasta-plain "$FASTA_PLAIN" --outdir "$ROOT" --gtf "$GTF_PLAIN" > "$ROOT/ercc.txt"
  source <(sed 's/^/export /' "$ROOT/ercc.txt")

  cat > "$ROOT/datasheet.yml" <<EOF
- genome: "$GID"
  species: "$GID"
  fasta: "$FASTA_PLAIN"
EOF
  if [[ -n "${GTF_STAGED:-}" ]]; then
    echo "  gtf: \"$GTF_STAGED\"" >> "$ROOT/datasheet.yml"
  fi

  nextflow run "$NF_PIPELINE" -r "$NF_REVISION" -profile "$NXF_PROFILE" \
    --input "$ROOT/datasheet.yml" --outdir "$ROOT/indices" \
    --max_cpus 40 --max_memory 200GB -work-dir "$ROOT/indices/work" \
    --tools "$TOOLS"

  if [[ -n "$ERCC_FASTA" ]]; then
    ERCC_ID="${GID}_with_ERCC"
    ERCC_ROOT="$OUTDIR/$ERCC_ID"
    mkdir -p "$ERCC_ROOT"
    cat > "$ERCC_ROOT/datasheet.yml" <<EOF
- genome: "$ERCC_ID"
  species: "$ERCC_ID"
  fasta: "$ERCC_FASTA"
EOF
    if [[ -n "${ERCC_GTF:-}" ]]; then
      echo "  gtf: \"$ERCC_GTF\"" >> "$ERCC_ROOT/datasheet.yml"
    fi

    nextflow run "$NF_PIPELINE" -r "$NF_REVISION" -profile "$NXF_PROFILE" \
      --input "$ERCC_ROOT/datasheet.yml" --outdir "$ERCC_ROOT/indices" \
      --max_cpus 40 --max_memory 200GB -work-dir "$ERCC_ROOT/indices/work" \
      --tools "$TOOLS"
  fi
done
