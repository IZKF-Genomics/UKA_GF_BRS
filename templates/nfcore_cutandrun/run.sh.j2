#!/usr/bin/env bash
set -euo pipefail

echo "[info] $(date) nf-core/cutandrun profile=docker"
nextflow -version || true
mkdir -p "results"

nextflow run nf-core/cutandrun \
  -r dcaf19ac1bbd26daf321289a7ea6e1be24c19ddc \
  -profile "docker" \
  -c nextflow.config \
  --input "samplesheet.csv" \
  --outdir "results" \
  --genome "{{ ctx.params.genome }}" \
  --normalisation_mode "{{ ctx.params.normalisation_mode }}" \
  --peakcaller "{{ ctx.params.peakcaller }}" \
  --use_control "{{ ctx.params.use_control }}" \
  --igg_scale_factor "{{ ctx.params.igg_scale_factor }}" \
{% if ctx.params.dedup_target_reads %}
  --dedup_target_reads \
{% endif %}
{% if ctx.params.get("spikein_fasta") %}
  --spikein_fasta "{{ ctx.params.spikein_fasta }}" \
{% endif %}
{% if ctx.params.get("spikein_bowtie2") %}
  --spikein_bowtie2 "{{ ctx.params.spikein_bowtie2 }}" \
{% endif %}
{% if ctx.params.max_cpus %}
  --max_cpus "{{ ctx.params.max_cpus }}" \
{% endif %}
{% if ctx.params.max_memory %}
  --max_memory "{{ ctx.params.max_memory }}" \
{% endif %}
  --igenomes_ignore true \
  --blacklist blacklist_path

# Available blacklist files (v2) for manual use:
# /data/ref_genome_blacklists/ce10-blacklist.v2.bed.gz
# /data/ref_genome_blacklists/ce11-blacklist.v2.bed.gz
# /data/ref_genome_blacklists/dm3-blacklist.v2.bed.gz
# /data/ref_genome_blacklists/dm6-blacklist.v2.bed.gz
# /data/ref_genome_blacklists/hg19-blacklist.v2.bed.gz
# /data/ref_genome_blacklists/hg38-blacklist.v2.bed.gz
# /data/ref_genome_blacklists/mm10-blacklist.v2.bed.gz

nextflow clean "$(grep -oP 'Run name:\s+\K\S+' .nextflow.log | tail -n 1)" -f
