#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

mkdir -p results/logs
LOG_FILE="results/logs/run_$(date +%Y%m%d_%H%M%S).log"

required=(pixi.toml config/project.toml config/samples.csv)
for f in "${required[@]}"; do
  if [[ ! -f "$f" ]]; then
    echo "ERROR: missing required file: $f" >&2
    exit 1
  fi
done

echo "[INFO] Running Illumina methylation array pipeline for {{ ctx.params.study_name | default('study') }}" | tee -a "$LOG_FILE"
echo "[INFO] Root: $ROOT_DIR" | tee -a "$LOG_FILE"

if command -v pixi >/dev/null 2>&1; then
  :
else
  echo "ERROR: pixi not found on PATH" | tee -a "$LOG_FILE" >&2
  exit 1
fi

pixi install 2>&1 | tee -a "$LOG_FILE"
pixi run check 2>&1 | tee -a "$LOG_FILE"
pixi run render 2>&1 | tee -a "$LOG_FILE"

echo "[INFO] Complete. Reports written to reports/" | tee -a "$LOG_FILE"
