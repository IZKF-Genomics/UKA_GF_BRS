
####################################################################
#  DGEA_constructor.qmd
#  Single control point for running DGEA reports
#  Style mirrors the legacy constructor: inherit a global config,
#  override per report, render explicitly. No hidden RData.
####################################################################

# 0) Inputs from ctx (resolved by pre_render hook; override here if needed)
salmon_dir <- "{{ ctx.materialize(ctx.params.salmon_dir) }}"
samplesheet_path <- "{{ ctx.materialize(ctx.params.nfcore_samplesheet) }}"
organism <- "{{ ctx.params.organism }}" # hsapiens, mmusculus, rnorvegicus
ercc <- {{ "TRUE" if ctx.params.ercc else "FALSE" }}
application <- "{{ ctx.params.application }}"
project_name <- "{{ ctx.params.name }}"
authors <- "{{ ctx.params.authors }}"
tx2gene_file <- file.path(salmon_dir, "tx2gene.tsv")

####################################################################
# 1) Libraries and helpers
####################################################################
library(dplyr)
library(tidyr)
library(tibble)
library(tidyverse)
library(knitr)
library(DT)
source("DGEA_functions.R")

check_missing_dirs(c(salmon_dir))

####################################################################
# 2) Load samplesheet (master sheet used by all reports)
####################################################################
samplesheet <- read.csv(samplesheet_path) %>%
  dplyr::select(-2, -3, -4) %>% # dropping unneeded columns
  separate(sample, into = c("group", "id"), sep = "_", remove = FALSE) %>% # split sample names into 2 columns
  dplyr::mutate(sample_copy = sample) %>% # Create a copy of the sample column
  tibble::column_to_rownames(var = "sample_copy") # Make sample_copy as rownames

####################################################################
# 3) Global config (inherits to each report; override per report)
####################################################################
# Global configuration list containing project paths and parameters
global_config <- list(
  # Add samplesheet to the global configuration
  samplesheet = samplesheet,
  samplesheet_path = samplesheet_path,
  # Project Paths (override per report as needed)
  salmon_dir = salmon_dir,
  tx2gene_file = tx2gene_file,

  # Run Specifications
  paired = FALSE, # Pairwise comparison or not
  design_formula = "~ group", # simple comparison by group column
  # design_formula = "~ id + group" # pairwise by id and compare by group column
  # design_formula = "~ id + group * treatment" # Captures whether the effect of treatment depends on the group
  norm_spikein_ercc = FALSE,
  organism = organism, # Define organism for GO/GSEA e.g., "hsapiens", "mmusculus", "rnorvegicus"
  highlighted_genes = NULL, # e.g., c("Gene1", "Gene2") for highlighting genes in all figures
  go = TRUE,
  gsea = TRUE,

  # Cutoffs
  cutoff_adj_p = 0.05,
  cutoff_log2fc = 1,
  pvalueCutoff_GO = 0.05,
  pvalueCutoff_GSEA = 0.05
)

####################################################################
# 4) Render reports (explicit, per-report overrides)
####################################################################

####################################################################
# Render DGEA for all samples
# This report is used for an overview of all data without any comparison
# No Rmd file is generated.
render_DGEA_all_sample(global_config)

####################################################################
# Render DGEA report
# `report_config` inherits `global_config` and enables flexible customization.
# The generated Rmd aims to be a stand-alone Rmd without dependency to this constructor.
report_config <- global_config
# unique(report_config$samplesheet$group)
report_config$base_group <- "WT"
report_config$target_group <- "KO"
######## You can further customize and overwrite any items ########
# report_config$salmon_dir <- Another path
# report_config$tx2gene_file <- Another path
# report_config$paired <- FALSE
# report_config$additional_tag <- ""
# report_config$samplesheet <- another samplesheet
# report_config$design_formula <- "~ batch + group * treatment"
# report_config$organism <- organism
# report_config$go <- FALSE
# report_config$gsea <- FALSE
render_DGEA_report(report_config)

####################################################################
# Render DGEA correlation analysis (optional; uncomment to enable)
# Expects DGEA_<tag>_genes_stats.csv files from prior DGEA runs.
# correlation_params <- list(
#   authors = report_config$authors %||% "PROJECT_AUTHORS",
#   comparisons = list(
#     list(title = "Correlation of IL10 and LPS (WT)", x = "IL10_vs_Control_in_WT", y = "LPS_vs_Control_in_WT"),
#     list(title = "Correlation of IL10 and LPS (KO)", x = "IL10_vs_Control_in_KO", y = "LPS_vs_Control_in_KO")
#   )
# )
# quarto::quarto_render(
#   input = "DGEA_correlation_analysis.qmd",
#   output_file = "DGEA_correlation_analysis.html",
#   execute_params = correlation_params,
#   quiet = FALSE
# )

####################################################################
# Render DGEA geneset comparisons (optional; uncomment to enable)
# Expects DGEA_*_stat.csv files from prior DGEA runs.
# geneset_params <- list(
#   authors = report_config$authors %||% "PROJECT_AUTHORS",
#   cutoff_adj_p = report_config$cutoff_adj_p %||% 0.05,
#   cutoff_log2fc = report_config$cutoff_log2fc %||% 1,
#   gene_sets = list(
#     list(name = "Generation2", file = "DGEA_Generation2_vs_WT_stat.csv"),
#     list(name = "Generation3", file = "DGEA_Generation3_vs_WT_stat.csv"),
#     list(name = "Generation4", file = "DGEA_Generation4_vs_WT_stat.csv"),
#     list(name = "Gender", file = "DGEA_Female_vs_Male_stat.csv")
#   )
# )
# quarto::quarto_render(
#   input = "DGEA_Geneset_Comparisons.qmd",
#   output_file = "DGEA_Geneset_Comparisons.html",
#   execute_params = geneset_params,
#   quiet = FALSE
# )

####################################################################
# Render DGEA integrated heatmap (optional; uncomment to enable)
# Expects DGEA_*_stat.csv, DGEA_All_samples_norm_counts.csv, and
# optional DGEA_*vs*_export.xlsx (GSEA) files from prior DGEA runs.
# heatmap_params <- list(
#   authors = report_config$authors %||% "PROJECT_AUTHORS",
#   padj_threshold = report_config$cutoff_adj_p %||% 0.05,
#   stat_files_pattern = "DGEA_.*_stat\\.csv$",
#   stat_files_exclude_regex = "all_samples",
#   top_n_all = NULL,
#   top_n_100 = 100,
#   top_n_10 = 10,
#   top_n_single = 20,
#   single_comparison_file = "DGEA_Generation2_vs_WT_stat.csv",
#   gsea_min_log10_padj = 7
# )
# quarto::quarto_render(
#   input = "DGEA_integrated_heatmap.qmd",
#   output_file = "DGEA_integrated_heatmap.html",
#   execute_params = heatmap_params,
#   quiet = FALSE
# )

####################################################################
# Render simple comparison report (optional; uncomment to enable)
# Requires selecting sample1/sample2 and access to counts in salmon_dir.
# simple_params <- list(
#   salmon_dir = report_config$salmon_dir,
#   samplesheet_path = report_config$samplesheet_path,
#   organism = report_config$organism,
#   ercc = isTRUE(report_config$ercc),
#   application = report_config$application,
#   name = report_config$name %||% "project",
#   authors = report_config$authors %||% "PROJECT_AUTHORS",
#   sample1 = "SampleA",
#   sample2 = "SampleB",
#   filetag = ""
# )
# quarto::quarto_render(
#   input = "SimpleComparison_template.qmd",
#   output_file = paste0("SimpleComparison_", simple_params$sample2, "_vs_", simple_params$sample1, ".html"),
#   execute_params = simple_params,
#   quiet = FALSE
# )
